worker_processes auto;

# to get access to additional modules from "nginx-extra" package
include /etc/nginx/modules-enabled/*.conf;


events {
  worker_connections 1024;
}

http {
  include /etc/nginx/conf.d/*.conf;

  upstream flask_app {
    server flask_webapp:8080;
  }

  # neccessary for many server{}-blocks
  server_names_hash_bucket_size 64;

  access_log /var/log/nginx/access.log;
  error_log /var/log/nginx/error.log;

  more_clear_headers 'server';

  

  server {
    listen 80 default_server;
    listen [::]:80 default_server;
    return 301 https://$host$request_uri;

  }

  server {

      server_name hippocooking.com;

      listen 443 ssl http2;
      listen [::]:443 ssl http2;

      

      #gzip
      # gzip on;
      # gzip_comp_level 6;
      # gzip_min_length 1000;
      # gzip_proxied any;
      # gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
      # gzip_buffers 16 8k;
      # gzip_vary on;
      # gzip_http_version 1.1;
      # gzip_disable "MSIE [1-6]\.";

      # Common TLS Config
      ssl_certificate     /etc/letsencrypt/live/hippocooking.com/fullchain.pem;
      ssl_certificate_key /etc/letsencrypt/live/hippocooking.com/privkey.pem;
      ssl_dhparam         /etc/ssl/certs/dhparam.pem;
      ssl_protocols       TLSv1.2 TLSv1.3;
      ssl_session_cache   shared:SSL:10m;
      ssl_session_timeout 10m;
      ssl_ciphers         "EECDH-AESGCM:EDH+ESGCM:AES256+EECDH:AES256+EDH";
      ssl_prefer_server_ciphers on;
      add_header          Strict-Transport-Security "max-age=31557600; includeSubdomains" always;
  
      #   rewrite_log on;
 
      include mime.types;
      default_type       application/octet-stream;
      access_log         /var/log/nginx/access.log;
      sendfile           on;
  #   tcp_nopush         on;
      keepalive_timeout  3;
  #   tcp_nodelay        on;
  #   gzip               on;
          #php max upload limit cannot be larger than this       
      client_max_body_size 13m;
      index              index.php index.html index.htm;
  
      # Upstream to abstract backend connection(s) for PHP.
      upstream php {
                  #this should match value of "listen" directive in php-fpm pool
          server wordpress:8000;
  #       server 127.0.0.1:9000;
      }

  }

  server {
      server_name blackandwhitedata.com;
      
      listen 443 ssl http2;
      listen [::]:443 ssl http2;

      #gzip
      gzip            on;
      gzip_min_length 1000;
      gzip_proxied    expired no-cache no-store private auth;
      gzip_types      text/plain text/css text/xml
      application/javascript application/json application/xml application/rss+xml image/svg+xml;
  
      # Common TLS Config
      ssl_certificate     /etc/letsencrypt/live/blackandwhitedata.com/fullchain.pem;
      ssl_certificate_key /etc/letsencrypt/live/blackandwhitedata.com/privkey.pem;
      ssl_dhparam         /etc/ssl/certs/dhparam.pem;
      ssl_protocols       TLSv1.2 TLSv1.3;
      ssl_session_cache   shared:SSL:10m;
      ssl_session_timeout 10m;
      ssl_ciphers         "EECDH-AESGCM:EDH+ESGCM:AES256+EECDH:AES256+EDH";
      ssl_prefer_server_ciphers on;
      add_header          Strict-Transport-Security "max-age=31557600; includeSubdomains" always;


      location / {

        include uwsgi_params;
        uwsgi_pass flask_app;

        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
        
        # container needs to know it doesn't run on "http://some-service-running-inside-docker" 
        uwsgi_param   HTTP_X-Forwarded-Host       blackandwhitedata.com;
        uwsgi_param   X-Forwarded-Proto       https;
        uwsgi_param   X-Forwarded-For       $remote_addr;
        uwsgi_param   X-Forwarded-IP       $remote_addr;
    
      }

      location /.well-known/brave-rewards-verification.txt {
        alias /etc/letsencrypt/wk/bravetoken.txt;
      }

      location /robots.txt {
        alias /etc/letsencrypt/wk/myrobots.txt;
      }
  }

}


